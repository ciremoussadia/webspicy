$LOAD_PATH.unshift File.expand_path("..", __FILE__)
require 'app'
require 'webspicy'

desc "Checks all .yml definition files"
task :check do
  config = Webspicy::Configuration.new(Path.dir/"webspicy")
  Webspicy::Checker.new(config).call
end

namespace :test do
  desc "Run all tests directly on Sinatra application using rack/test"
  task :rack do
    config = Webspicy::Configuration.new(Path.dir/"webspicy") do |c|
      c.client = Webspicy::RackTestClient.for(::Sinatra::Application)
      c.before_each do |_,_,_,client|
        client.api.post "/reset"
      end
    end
    Webspicy::Tester.new(config).call
  end

  desc "Runs all tests on the real web server (must be launched previously)"
  task :real do
    config = Webspicy::Configuration.new(Path.dir/"webspicy") do |c|
      c.host = "http://127.0.0.1:4567"
      c.client = Webspicy::HttpClient
      c.before_each do |_,_,_,client|
        client.api.post "http://127.0.0.1:4567/reset"
      end
    end
    Webspicy::Tester.new(config).call
  end
end

desc "Runs all checks and tests"
task :test => :check
task :test => :"test:rack"

task :default => :test
